// = Your Blog title
// See https://hubpress.gitbooks.io/hubpress-knowledgebase/content/ for information about the parameters.
// :hp-image: /covers/cover.png
// :published_at: 2019-01-31
// :hp-tags: HubPress, Blog, Open_Source,
// :hp-alt-title: My English Title

= Proxmox VE: Virtualization for Work and Play
:hp-alt-title: Server Virtualization Management
:hp-tags: Blog, Open_Source, Technology
:icons: image
:toc: macro 

toc::[]

//link:/2017/04/15/Identifying-the-Successful-Completion-of-Weight-Lifting-Exercises[next]

== Introduction

Say we want a powerful "bang for the buck" home server for games _and_ other system-intensive pursuits. We may want to run powerful analytics applications which would undoubtably require Linux, but we may also want to run Windows applications. We may want near native 2D and 3D graphics performance inside the guest operating system (OS) while making dual-booting obsolete. Finally, we may want to do all of that from the comfort of our couch using a Windows, Linux or Mac laptop. 

With the link:https://opensource.org/[open source] server management solution, link:https://www.proxmox.com/en/[Proxmox Virtual Environment (PVE)], we can achieve these goals. PVE enables the creation of multiple virtual OS "servers" via a Web GUI; as many as our hardware setup will allow. This guide will document the setup of Proxmox on the following hardware:

* AMD Ryzen 7 1600 (8 cores, 16 threads @ 3.7GHz)
* 64GB 2400MHz DDR4
* Boot Drive: 1x 512GB NVMe SSD 
* Storage (Striped-mirrored ZFS):
** 2x 1TB SATA SSD (striped)
** 1x 2TB 7200rpm mechanical drives (mirrored)

== Hardware Considerations

Our CPU and motherboard must support "virtualization” (SVM) and IOMMU, which needs to be enabled in firmware for resource sharing. Also, we should have 32GB of RAM or more, so that we can reserve at least 16GB for a single virtual machine (VM) and still have enough memory left over for ProxMox and potentially other VMs running simultaneously.

While most of our computer hardware can be shared between multiple VMs, the graphics card (GPU) cannot readily be shared. We'll need at least two GPUs:

. One GPU for ProxMox (the host);
. One powerful GPU for our VMs (the guests: Windows, Linux, etc.).

== Software Considerations

link:https://jannikjung.me/proxmox-ve-5-0-beta1/[PVE 5.0] is based in link:https://wiki.debian.org/DebianStretch[Debian Linux (Stretch)]. Since our Ryzen hardware is rather new, our host system needs to have a Linux kernel version 4.10 or later. Although in beta at the time of this writing, PVE 5.0 has better support for Ryzen than PVE 4.4.

PVE natively supports both link:https://www.linux-kvm.org/page/Main_Page[KVM virtual machines] for hardware virtualization and link:https://linuxcontainers.org/lxc/introduction/[LXC containers]. Since the guest systems can run under hardware virtualization, we get some added bonuses. For example, we can benefit from Ryzen hardware and still get link:http://www.pcworld.com/article/3189990/windows/microsoft-blocks-kaby-lake-and-ryzen-pcs-from-windows-7-81-updates.html[Windows 7 updates]. We would need to identify our Windows link:https://www.nextofwindows.com/the-best-way-to-uniquely-identify-a-windows-machine[Universally Unique Identifier (UUID)] so that it may be identical on our VM. Otherwise Microsoft may think that we have a new version of Windows that needs to be registered.

We will use link:https://github.com/zfsonlinux/zfs/wiki/faq[ZFS], a storage platform that encompasses the functionality of traditional filesystems, volume managers, and more, with consistent reliability, functionality and performance. Our ZFS installation will be compressed and striped: our two SSD drives will run in parallel and require less storage space, which improves read/write performance. In addition, our ZFS will be mirrored: our SSD drives will be cloned so that we have a backup in case of drive failure.

[cols="1, 8a"]
|===
^.^|image:/images/icons/lightbulb.png[icon="tip",size="4x",width=56]
|*About That*: KVM supports multiple disk formats; raw images, the native QEMU format (qcow2), VMware format, and many more. When working with ZFS on PVE, we need to use raw images. It may not seem obvious at first, but we can easily convert an existing KVM file from one format to a raw image. Near the end of this guide, we'll cover the process to convert a qcow2 format to the required PVE raw image.
|===

== Installation

https://forum.level1techs.com/t/proxmox-zfs-with-ssd-caching-setup-guide/97663
https://pve.proxmox.com/wiki/Quick_installation

Disconnect all the drives except the boot drive

KVM

== Post-Install

=== Security

https://www.kiloroot.com/secure-proxmox-install-sudo-firewall-with-ipv6-and-more-how-to-configure-from-start-to-finish/


=== Optimization


Remove Proxmox License Nag: sed -i.bak "s/data.status !== 'Active'/false/g" /usr/share/pve-manager/ext6/pvemanagerlib.js

For good performance, we need to configure SPICE (Simple Protocol for Independent Computing Environments). The SPICE packages include drivers (QXL and virtio) that enhance virtualization performance:

* SPICE Client (virt-viewer) for Linux, Windows, and Mac systems
* SPICE Guest Tools for the virtual machines

https://pve.proxmox.com/wiki/Paravirtualized_Block_Drivers_for_Windows

https://pve.proxmox.com/wiki/Windows_7_guest_best_practices

https://pve.proxmox.com/wiki/SPICE

https://www.spice-space.org/download.html

=== Further Tweaks

==== Emulation Settings

In the file: /etc/pve/qemu-server/101.conf

* Update the following: `cpu: Haswell,hidden=1`
* Add the following: `args: ...`

==== GPU Passthrough

https://pve.proxmox.com/wiki/Pci_passthrough

Identify the video card: 
```
lspci -nn | grep `lspci | grep VGA | cut -d "." -f1` 
```

Take a note of the IDs in the square brackets near the end of each line: in my case 10de:1b80 (graphics) and 10de:10f0 (audio).

```
echo "options vfio-pci ids=10de:1b80,10de:10f0" > /etc/modprobe.d/vfio.conf
```

//Update the grub settings:

//* GRUB_CMDLINE_LINUX_DEFAULT="quiet splash" to:
//* GRUB_CMDLINE_LINUX_DEFAULT="quiet amd_iommu=on"

amd_iommu=on


